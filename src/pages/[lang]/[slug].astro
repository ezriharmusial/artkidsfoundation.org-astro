---
import { getCollection, getEntryBySlug } from 'astro:content';

import BaseLayout from "../../layouts/BaseLayout.astro";
import Icon from "astro-icon";

const sitePages = await getCollection('pages');

export async function getStaticPaths() {
	const sitePages = await getCollection('pages');
	return sitePages.map(page => {
		const [lang, slug] = page.slug.split('/')
		return {
			params: { lang, slug: slug || undefined },
			props: { page }
		}
	});
}

// 1. Get the slug from the incoming server request
const { page } = Astro.props;
// 2. Query for the page directly using the request slug
const { Content, headings  } = await page?.render() ;

//console.log('Page entry', slug, page)

---
<BaseLayout icon={page.data?.icon} pack={page.data?.pack} description={page.data?.description} title={page.data?.title} image={page.data?.image} imageAlt={page.data?.imageAlt}>

		<section class="bg-cover bg-center w-full" style="background-image: url('https://source.unsplash.com/random?galaxies');">
			<div class="bg-white/90 dark:bg-black/75 p-8 pt-16">
				<div class="mx-auto flex portrait:flex-col gap-8 items-center mb-8">
					{headings.length > 2 &&
					<div class="landscape:md:w-1/3 landscape:sm:1/3 landscape:xl:w-1/4 landscape:sticky landscape:top-4 landscape:self-start space-y-6 portrait:w-full portrait:pb-8 portrait:border-b portrait:border-primary-600-300-token">
						<h2 class="landscape:hidden marker text-primary-600 mb-8 unstyled drop-shadow landscape:text-4xl portrait:text-3xl font-bold">
							<span class="flex items-center justify-start">
								<Icon pack={page?.data.pack || "teenyicons"} name={page?.data.icon || "anchor-solid"} class={"h-8 w-8 lg:h-10 lg:w-10 portrait:h-10 portrait:w-10 p-1 portrait:pr-4"} />
								<span>
									{page?.data.title}
								</span>
							</span>
						</h2>

						<img src="https://source.unsplash.com/random?african%20children" class="portrait:aspect-video landscape:aspect-auto object-cover rounded-xl" alt="Layout Image">
						<h3>Page Content</h3>
						<ul class="list">
						{headings && headings.map(heading => (
							<li><a href={"#" + heading.slug}>{heading.text}</a></li>
						))}
						</ul>
					</div>
					}

					<div class="landscape:sm:2/3 landscape:md:w-2/3 landscape:xl:w-3/4 ">
						<div class="portrait:hidden">
						{page?.data.subtitle &&
							<h3 class="text-red-600 unstyled drop-shadow text-lg font-bold" >{page?.data.subtitle}</h3>
						}
						<h2 class="marker text-primary-600 mb-8 unstyled drop-shadow landscape:text-4xl portrait:text-3xl font-bold" >
							<span class="flex items-center justify-start">
								<Icon pack={page?.data.pack || "teenyicons"} name={page?.data.icon || "anchor-solid"} class={"h-8 w-8 lg:h-10 lg:w-10 portrait:h-10 portrait:w-10 p-1 portrait:pr-4"} />
								<span>
									{page?.data.title}
								</span>
							</span>
						</h2>
						</div>
						<div class="prose max-w-none prose-stone space-y-6 prose-table:table-auto prose-p:text-lg prose-p:text-primary-800-100-token prose-headings:text-primary-800-100-token">
							<Content />
						</div>
					</div>
				</div>
			</div>
		</section>

</BaseLayout>